============================= test session starts ==============================
platform linux -- Python 3.11.8, pytest-8.0.2, pluggy-1.4.0
rootdir: /code/quiz-app/quiz-app-backend
configfile: pyproject.toml
plugins: anyio-4.3.0, cov-4.1.0
collected 67 items

tests/test_api.py ...                                                    [  4%]
tests/test_api_authentication.py .......F.F....FFFFFFF                   [ 35%]
tests/test_api_question_sets.py .....                                    [ 43%]
tests/test_api_questions.py ....                                         [ 49%]
tests/test_api_user_responses.py .                                       [ 50%]
tests/test_api_users.py .F                                               [ 53%]
tests/test_auth_integration.py FFF                                       [ 58%]
tests/test_core_auth.py .                                                [ 59%]
tests/test_core_jwt.py ....                                              [ 65%]
tests/test_crud.py ...                                                   [ 70%]
tests/test_crud_question_sets.py ...                                     [ 74%]
tests/test_crud_questions.py .....                                       [ 82%]
tests/test_crud_user.py .                                                [ 83%]
tests/test_crud_user_responses.py .                                      [ 85%]
tests/test_db_session.py .                                               [ 86%]
tests/test_jwt.py .                                                      [ 88%]
tests/test_models.py ...                                                 [ 92%]
tests/test_schemas.py ...                                                [ 97%]
tests/test_schemas_user.py ..                                            [100%]

=================================== FAILURES ===================================
___________________ test_login_and_access_protected_endpoint ___________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 678, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 342, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 263, in <lambda>
    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 181, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_result.py", line 99, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 839, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 822, in _runtest_for
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/capture.py", line 882, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/skipping.py", line 256, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     raise e
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 170, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 1831, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 138, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 194, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/tests/test_api_authentication.py", line 61, in test_login_and_access_protected_endpoint
    |     response = client.get("/users/", headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 523, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 491, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 372, in handle_request
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 369, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 288, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 217, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/app/main.py", line 47, in check_blacklist
    |     if db.query(RevokedToken).filter(RevokedToken.token == token).first():
    |        ^^^^^^^^
    | AttributeError: 'Depends' object has no attribute 'query'
    +------------------------------------

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7feffebf1850>
test_user = <app.models.users.User object at 0x7feffea04190>

    def test_login_and_access_protected_endpoint(client, test_user):
        login_data = {"username": test_user.username, "password": "TestPassword123"}
        response = client.post("/token", data=login_data)
        assert response.status_code == 200
        access_token = response.json()["access_token"]
    
        # Access a protected endpoint using the token
        headers = {"Authorization": f"Bearer {access_token}"}
>       response = client.get("/users/", headers=headers)

tests/test_api_authentication.py:61: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:523: in get
    return super().get(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1054: in get
    return self.request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:491: in request
    return super().request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:827: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1015: in _send_single_request
    response = transport.handle_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:372: in handle_request
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:369: in handle_request
    portal.call(self.app, scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:288: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval_or_awaitable
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:189: in __call__
    with collapse_excgroups():
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py:93: in collapse_excgroups
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:191: in __call__
    response = await self.dispatch_func(request, call_next)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x7feffea17650>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7feffebc8fe0>
db = Depends(get_db)

    @app.middleware("http")
    async def check_blacklist(request: Request, call_next, db: Session = Depends(get_db)):
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header.split(" ")[1]
>           if db.query(RevokedToken).filter(RevokedToken.token == token).first():
E           AttributeError: 'Depends' object has no attribute 'query'

app/main.py:47: AttributeError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffebecc10>
----------------------------- Captured stdout call -----------------------------
Overriding get_db dependency with test session: <sqlalchemy.orm.session.Session object at 0x7feffebecc10>
Ending use of test session: <sqlalchemy.orm.session.Session object at 0x7feffebecc10>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffebecc10>
______________ test_access_protected_endpoint_with_invalid_token _______________
  + Exception Group Traceback (most recent call last):
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 678, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 342, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 263, in <lambda>
    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 181, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_result.py", line 99, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 839, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 822, in _runtest_for
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/capture.py", line 882, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/skipping.py", line 256, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     raise e
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 170, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 1831, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 138, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 194, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/tests/test_api_authentication.py", line 70, in test_access_protected_endpoint_with_invalid_token
    |     response = client.get("/users/", headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 523, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 491, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 372, in handle_request
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 369, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 288, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 217, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/app/main.py", line 47, in check_blacklist
    |     if db.query(RevokedToken).filter(RevokedToken.token == token).first():
    |        ^^^^^^^^
    | AttributeError: 'Depends' object has no attribute 'query'
    +------------------------------------

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7feffe20ab10>

    def test_access_protected_endpoint_with_invalid_token(client):
        headers = {"Authorization": "Bearer invalid_token"}
>       response = client.get("/users/", headers=headers)

tests/test_api_authentication.py:70: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:523: in get
    return super().get(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1054: in get
    return self.request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:491: in request
    return super().request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:827: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1015: in _send_single_request
    response = transport.handle_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:372: in handle_request
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:369: in handle_request
    portal.call(self.app, scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:288: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval_or_awaitable
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:189: in __call__
    with collapse_excgroups():
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py:93: in collapse_excgroups
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:191: in __call__
    response = await self.dispatch_func(request, call_next)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x7feffe209310>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7feffea35260>
db = Depends(get_db)

    @app.middleware("http")
    async def check_blacklist(request: Request, call_next, db: Session = Depends(get_db)):
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header.split(" ")[1]
>           if db.query(RevokedToken).filter(RevokedToken.token == token).first():
E           AttributeError: 'Depends' object has no attribute 'query'

app/main.py:47: AttributeError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe20a910>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe20a910>
______________________________ test_login_success ______________________________

client = <starlette.testclient.TestClient object at 0x7feffe431850>
test_user = <app.models.users.User object at 0x7feffe3e8a10>

    def test_login_success(client, test_user):
        response = client.post("/login", data={"username": test_user.username, "password": "TestPassword123"})
>       assert response.status_code == 200
E       assert 422 == 200
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

tests/test_api_authentication.py:105: AssertionError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe433610>
----------------------------- Captured stdout call -----------------------------
Overriding get_db dependency with test session: <sqlalchemy.orm.session.Session object at 0x7feffe433610>
Ending use of test session: <sqlalchemy.orm.session.Session object at 0x7feffe433610>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe433610>
________________________ test_login_invalid_credentials ________________________

client = <starlette.testclient.TestClient object at 0x7feffe431a90>

    def test_login_invalid_credentials(client):
        response = client.post("/login", data={"username": "invalid_user", "password": "invalid_password"})
>       assert response.status_code == 401
E       assert 422 == 401
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

tests/test_api_authentication.py:110: AssertionError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe432350>
----------------------------- Captured stdout call -----------------------------
Overriding get_db dependency with test session: <sqlalchemy.orm.session.Session object at 0x7feffe432350>
Ending use of test session: <sqlalchemy.orm.session.Session object at 0x7feffe432350>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe432350>
_____________________________ test_logout_success ______________________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 678, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 342, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 263, in <lambda>
    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 181, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_result.py", line 99, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 839, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 822, in _runtest_for
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/capture.py", line 882, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/skipping.py", line 256, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     raise e
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 170, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 1831, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 138, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 194, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/tests/test_api_authentication.py", line 115, in test_logout_success
    |     response = client.post("/logout", headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 608, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 491, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 372, in handle_request
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 369, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 288, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 217, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/app/main.py", line 47, in check_blacklist
    |     if db.query(RevokedToken).filter(RevokedToken.token == token).first():
    |        ^^^^^^^^
    | AttributeError: 'Depends' object has no attribute 'query'
    +------------------------------------

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7feffe9d6b90>
test_user = <app.models.users.User object at 0x7feffe9d7610>
test_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlcl9SdmtRVyIsImV4cCI6MTcxMDkwMzcxNn0.8rdExkKytBUd5FvakkCK9Da1jPVLMSQVAn5bC3SaA0Q'

    def test_logout_success(client, test_user, test_token):
        headers = {"Authorization": f"Bearer {test_token}"}
>       response = client.post("/logout", headers=headers)

tests/test_api_authentication.py:115: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:608: in post
    return super().post(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1145: in post
    return self.request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:491: in request
    return super().request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:827: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1015: in _send_single_request
    response = transport.handle_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:372: in handle_request
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:369: in handle_request
    portal.call(self.app, scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:288: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval_or_awaitable
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:189: in __call__
    with collapse_excgroups():
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py:93: in collapse_excgroups
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:191: in __call__
    response = await self.dispatch_func(request, call_next)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x7feffe3ea1d0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7feffea37100>
db = Depends(get_db)

    @app.middleware("http")
    async def check_blacklist(request: Request, call_next, db: Session = Depends(get_db)):
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header.split(" ")[1]
>           if db.query(RevokedToken).filter(RevokedToken.token == token).first():
E           AttributeError: 'Depends' object has no attribute 'query'

app/main.py:47: AttributeError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe9d5310>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe9d5310>
___________________________ test_login_inactive_user ___________________________

client = <starlette.testclient.TestClient object at 0x7feffe841210>
test_user = <app.models.users.User object at 0x7feffe8418d0>
db_session = <sqlalchemy.orm.session.Session object at 0x7feffe840d50>

    def test_login_inactive_user(client, test_user, db_session):
        # Set the user as inactive
        test_user.is_active = False
        db_session.commit()
    
        response = client.post("/login", data={"username": test_user.username, "password": "TestPassword123"})
>       assert response.status_code == 403
E       assert 422 == 403
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

tests/test_api_authentication.py:125: AssertionError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe840d50>
----------------------------- Captured stdout call -----------------------------
Overriding get_db dependency with test session: <sqlalchemy.orm.session.Session object at 0x7feffe840d50>
Ending use of test session: <sqlalchemy.orm.session.Session object at 0x7feffe840d50>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe840d50>
_______________________ test_login_invalid_token_format ________________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 678, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 342, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 263, in <lambda>
    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 181, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_result.py", line 99, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 839, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 822, in _runtest_for
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/capture.py", line 882, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/skipping.py", line 256, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     raise e
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 170, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 1831, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 138, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 194, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/tests/test_api_authentication.py", line 130, in test_login_invalid_token_format
    |     response = client.get("/users/", headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 523, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 491, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 372, in handle_request
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 369, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 288, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 217, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/app/main.py", line 47, in check_blacklist
    |     if db.query(RevokedToken).filter(RevokedToken.token == token).first():
    |        ^^^^^^^^
    | AttributeError: 'Depends' object has no attribute 'query'
    +------------------------------------

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7ff000bb61d0>

    def test_login_invalid_token_format(client):
        headers = {"Authorization": "Bearer invalid_token_format"}
>       response = client.get("/users/", headers=headers)

tests/test_api_authentication.py:130: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:523: in get
    return super().get(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1054: in get
    return self.request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:491: in request
    return super().request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:827: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1015: in _send_single_request
    response = transport.handle_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:372: in handle_request
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:369: in handle_request
    portal.call(self.app, scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:288: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval_or_awaitable
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:189: in __call__
    with collapse_excgroups():
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py:93: in collapse_excgroups
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:191: in __call__
    response = await self.dispatch_func(request, call_next)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x7feffe63a3d0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7feffea36160>
db = Depends(get_db)

    @app.middleware("http")
    async def check_blacklist(request: Request, call_next, db: Session = Depends(get_db)):
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header.split(" ")[1]
>           if db.query(RevokedToken).filter(RevokedToken.token == token).first():
E           AttributeError: 'Depends' object has no attribute 'query'

app/main.py:47: AttributeError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe842fd0>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe842fd0>
___________________________ test_login_expired_token ___________________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 678, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 342, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 263, in <lambda>
    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 181, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_result.py", line 99, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 839, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 822, in _runtest_for
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/capture.py", line 882, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/skipping.py", line 256, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     raise e
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 170, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 1831, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 138, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 194, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/tests/test_api_authentication.py", line 138, in test_login_expired_token
    |     response = client.get("/users/", headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 523, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 491, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 372, in handle_request
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 369, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 288, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 217, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/app/main.py", line 47, in check_blacklist
    |     if db.query(RevokedToken).filter(RevokedToken.token == token).first():
    |        ^^^^^^^^
    | AttributeError: 'Depends' object has no attribute 'query'
    +------------------------------------

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7feffe873b50>
test_user = <app.models.users.User object at 0x7feffe872d90>
test_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlcl9xR3A4NSIsImV4cCI6MTcxMDkwMzcxOH0.qFJIcjNJHZCABtxRGbM1wCeUiQbQ42CIdrVA4CcmB8g'

    def test_login_expired_token(client, test_user, test_token):
        # Create an expired token
        expired_token = create_access_token(data={"sub": test_user.username}, expires_delta=timedelta(minutes=-1))
        headers = {"Authorization": f"Bearer {expired_token}"}
>       response = client.get("/users/", headers=headers)

tests/test_api_authentication.py:138: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:523: in get
    return super().get(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1054: in get
    return self.request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:491: in request
    return super().request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:827: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1015: in _send_single_request
    response = transport.handle_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:372: in handle_request
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:369: in handle_request
    portal.call(self.app, scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:288: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval_or_awaitable
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:189: in __call__
    with collapse_excgroups():
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py:93: in collapse_excgroups
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:191: in __call__
    response = await self.dispatch_func(request, call_next)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x7feffe872050>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7feffeab0cc0>
db = Depends(get_db)

    @app.middleware("http")
    async def check_blacklist(request: Request, call_next, db: Session = Depends(get_db)):
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header.split(" ")[1]
>           if db.query(RevokedToken).filter(RevokedToken.token == token).first():
E           AttributeError: 'Depends' object has no attribute 'query'

app/main.py:47: AttributeError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe873690>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe873690>
____________________________ test_login_logout_flow ____________________________

client = <starlette.testclient.TestClient object at 0x7feffe7ca510>
test_user = <app.models.users.User object at 0x7feffe7caf50>

    def test_login_logout_flow(client, test_user):
        # Login
        login_data = {"username": test_user.username, "password": "TestPassword123"}
        login_response = client.post("/login", data=login_data)
>       assert login_response.status_code == 200
E       assert 422 == 200
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

tests/test_api_authentication.py:146: AssertionError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe7ca1d0>
----------------------------- Captured stdout call -----------------------------
Overriding get_db dependency with test session: <sqlalchemy.orm.session.Session object at 0x7feffe7ca1d0>
Ending use of test session: <sqlalchemy.orm.session.Session object at 0x7feffe7ca1d0>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe7ca1d0>
_______________________________ test_read_users ________________________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 678, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 342, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 263, in <lambda>
    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 181, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_result.py", line 99, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 839, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 822, in _runtest_for
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/capture.py", line 882, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/skipping.py", line 256, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     raise e
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 170, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 1831, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 138, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 194, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/tests/test_api_users.py", line 16, in test_read_users
    |     response = client.get("/users/", headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 523, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 491, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 372, in handle_request
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 369, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 288, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 217, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/app/main.py", line 47, in check_blacklist
    |     if db.query(RevokedToken).filter(RevokedToken.token == token).first():
    |        ^^^^^^^^
    | AttributeError: 'Depends' object has no attribute 'query'
    +------------------------------------

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7feffe552490>
db_session = <sqlalchemy.orm.session.Session object at 0x7feffe552ed0>
test_user = <app.models.users.User object at 0x7feffe7c8450>

    def test_read_users(client, db_session, test_user):
        # Authenticate and get the access token
        login_data = {"username": test_user.username, "password": "TestPassword123"}
        response = client.post("/token", data=login_data)
        assert response.status_code == 200
        access_token = response.json()["access_token"]
    
        # Make the request to the /users/ endpoint with the access token
        headers = {"Authorization": f"Bearer {access_token}"}
>       response = client.get("/users/", headers=headers)

tests/test_api_users.py:16: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:523: in get
    return super().get(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1054: in get
    return self.request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:491: in request
    return super().request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:827: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1015: in _send_single_request
    response = transport.handle_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:372: in handle_request
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:369: in handle_request
    portal.call(self.app, scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:288: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval_or_awaitable
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:189: in __call__
    with collapse_excgroups():
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py:93: in collapse_excgroups
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:191: in __call__
    response = await self.dispatch_func(request, call_next)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x7feffe8ba290>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7feffeacca40>
db = Depends(get_db)

    @app.middleware("http")
    async def check_blacklist(request: Request, call_next, db: Session = Depends(get_db)):
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header.split(" ")[1]
>           if db.query(RevokedToken).filter(RevokedToken.token == token).first():
E           AttributeError: 'Depends' object has no attribute 'query'

app/main.py:47: AttributeError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe552ed0>
----------------------------- Captured stdout call -----------------------------
Overriding get_db dependency with test session: <sqlalchemy.orm.session.Session object at 0x7feffe552ed0>
Ending use of test session: <sqlalchemy.orm.session.Session object at 0x7feffe552ed0>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe552ed0>
____________________ test_protected_route_with_valid_token _____________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 678, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 342, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 263, in <lambda>
    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 181, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_result.py", line 99, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 839, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 822, in _runtest_for
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/capture.py", line 882, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/skipping.py", line 256, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     raise e
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 170, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 1831, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 138, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 194, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/tests/test_auth_integration.py", line 3, in test_protected_route_with_valid_token
    |     response = client.get("/users/", headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 523, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 491, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 372, in handle_request
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 369, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 288, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 217, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/app/main.py", line 47, in check_blacklist
    |     if db.query(RevokedToken).filter(RevokedToken.token == token).first():
    |        ^^^^^^^^
    | AttributeError: 'Depends' object has no attribute 'query'
    +------------------------------------

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7feffe3f2450>
test_user = <app.models.users.User object at 0x7feffe3f1550>
test_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlcl9Eb3F2SSIsImV4cCI6MTcxMDkwMzcyMn0.2uIQ2pNbVuIoxlequEA-8gr5dU5uSIOeyAJ64lTgvJQ'

    def test_protected_route_with_valid_token(client, test_user, test_token):
        headers = {"Authorization": f"Bearer {test_token}"}
>       response = client.get("/users/", headers=headers)

tests/test_auth_integration.py:3: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:523: in get
    return super().get(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1054: in get
    return self.request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:491: in request
    return super().request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:827: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1015: in _send_single_request
    response = transport.handle_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:372: in handle_request
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:369: in handle_request
    portal.call(self.app, scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:288: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval_or_awaitable
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:189: in __call__
    with collapse_excgroups():
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py:93: in collapse_excgroups
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:191: in __call__
    response = await self.dispatch_func(request, call_next)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x7feffe7c5fd0>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7feffeab0400>
db = Depends(get_db)

    @app.middleware("http")
    async def check_blacklist(request: Request, call_next, db: Session = Depends(get_db)):
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header.split(" ")[1]
>           if db.query(RevokedToken).filter(RevokedToken.token == token).first():
E           AttributeError: 'Depends' object has no attribute 'query'

app/main.py:47: AttributeError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe3f2510>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe3f2510>
___________________ test_protected_route_with_invalid_token ____________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 678, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 342, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 263, in <lambda>
    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 181, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_result.py", line 99, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 839, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 822, in _runtest_for
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/capture.py", line 882, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/skipping.py", line 256, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     raise e
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 170, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 1831, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 138, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 194, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/tests/test_auth_integration.py", line 8, in test_protected_route_with_invalid_token
    |     response = client.get("/users/", headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 523, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 491, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 372, in handle_request
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 369, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 288, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 217, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/app/main.py", line 47, in check_blacklist
    |     if db.query(RevokedToken).filter(RevokedToken.token == token).first():
    |        ^^^^^^^^
    | AttributeError: 'Depends' object has no attribute 'query'
    +------------------------------------

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7feffe85a590>

    def test_protected_route_with_invalid_token(client):
        headers = {"Authorization": "Bearer invalid_token"}
>       response = client.get("/users/", headers=headers)

tests/test_auth_integration.py:8: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:523: in get
    return super().get(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1054: in get
    return self.request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:491: in request
    return super().request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:827: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1015: in _send_single_request
    response = transport.handle_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:372: in handle_request
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:369: in handle_request
    portal.call(self.app, scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:288: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval_or_awaitable
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:189: in __call__
    with collapse_excgroups():
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py:93: in collapse_excgroups
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:191: in __call__
    response = await self.dispatch_func(request, call_next)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x7feffe85bd50>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7feffea37420>
db = Depends(get_db)

    @app.middleware("http")
    async def check_blacklist(request: Request, call_next, db: Session = Depends(get_db)):
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header.split(" ")[1]
>           if db.query(RevokedToken).filter(RevokedToken.token == token).first():
E           AttributeError: 'Depends' object has no attribute 'query'

app/main.py:47: AttributeError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe85a290>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe85a290>
___________________ test_protected_route_with_revoked_token ____________________
  + Exception Group Traceback (most recent call last):
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 678, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 342, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 263, in <lambda>
    |     lambda: ihook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 181, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_result.py", line 99, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 839, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/logging.py", line 822, in _runtest_for
    |     yield
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/capture.py", line 882, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 166, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/skipping.py", line 256, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 178, in pytest_runtest_call
    |     raise e
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/runner.py", line 170, in pytest_runtest_call
    |     item.runtest()
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 1831, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_hooks.py", line 501, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_manager.py", line 119, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 138, in _multicall
    |     raise exception.with_traceback(exception.__traceback__)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/pluggy/_callers.py", line 102, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/_pytest/python.py", line 194, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/tests/test_auth_integration.py", line 14, in test_protected_route_with_revoked_token
    |     logout_response = client.post("/logout", headers=headers)
    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 608, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 491, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 372, in handle_request
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py", line 369, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 288, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py", line 217, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py", line 158, in __exit__
    |     self.gen.throw(typ, value, traceback)
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/code/quiz-app/quiz-app-backend/app/main.py", line 47, in check_blacklist
    |     if db.query(RevokedToken).filter(RevokedToken.token == token).first():
    |        ^^^^^^^^
    | AttributeError: 'Depends' object has no attribute 'query'
    +------------------------------------

During handling of the above exception, another exception occurred:

client = <starlette.testclient.TestClient object at 0x7feffe71f690>
test_user = <app.models.users.User object at 0x7feffe71e950>
test_token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0ZXN0dXNlcl94SnBMRSIsImV4cCI6MTcxMDkwMzcyM30.69VyFqJk1k3YMJ5s0E-0rwpGFIMmegNvxg7Sseur-hc'

    def test_protected_route_with_revoked_token(client, test_user, test_token):
        # Logout to revoke the token
        headers = {"Authorization": f"Bearer {test_token}"}
>       logout_response = client.post("/logout", headers=headers)

tests/test_auth_integration.py:14: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:608: in post
    return super().post(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1145: in post
    return self.request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:491: in request
    return super().request(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:827: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:914: in send
    response = self._send_handling_auth(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:942: in _send_handling_auth
    response = self._send_handling_redirects(
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:979: in _send_handling_redirects
    response = self._send_single_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/httpx/_client.py:1015: in _send_single_request
    response = transport.handle_request(request)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:372: in handle_request
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/testclient.py:369: in handle_request
    portal.call(self.app, scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:288: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval_or_awaitable
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/fastapi/applications.py:1054: in __call__
    await super().__call__(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/applications.py:123: in __call__
    await self.middleware_stack(scope, receive, send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:186: in __call__
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/errors.py:164: in __call__
    await self.app(scope, receive, _send)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:189: in __call__
    with collapse_excgroups():
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/contextlib.py:158: in __exit__
    self.gen.throw(typ, value, traceback)
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/_utils.py:93: in collapse_excgroups
    raise exc
/home/astromined/anaconda3/envs/fastapi_quiz_app/lib/python3.11/site-packages/starlette/middleware/base.py:191: in __call__
    response = await self.dispatch_func(request, call_next)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

request = <starlette.middleware.base._CachedRequest object at 0x7feffe413650>
call_next = <function BaseHTTPMiddleware.__call__.<locals>.call_next at 0x7feffeacf880>
db = Depends(get_db)

    @app.middleware("http")
    async def check_blacklist(request: Request, call_next, db: Session = Depends(get_db)):
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header.split(" ")[1]
>           if db.query(RevokedToken).filter(RevokedToken.token == token).first():
E           AttributeError: 'Depends' object has no attribute 'query'

app/main.py:47: AttributeError
---------------------------- Captured stdout setup -----------------------------
Starting a new test session: <sqlalchemy.orm.session.Session object at 0x7feffe71f950>
--------------------------- Captured stdout teardown ---------------------------
Removed get_db override.
Test session committed.
Test session closed: <sqlalchemy.orm.session.Session object at 0x7feffe71f950>

---------- coverage: platform linux, python 3.11.8-final-0 -----------
Name                                  Stmts   Miss  Cover
---------------------------------------------------------
app/__init__.py                           0      0   100%
app/api/__init__.py                       1      0   100%
app/api/endpoints/__init__.py             1      0   100%
app/api/endpoints/auth.py                41     20    51%
app/api/endpoints/question_sets.py       42     11    74%
app/api/endpoints/questions.py           27      2    93%
app/api/endpoints/register.py            17      0   100%
app/api/endpoints/token.py               20      0   100%
app/api/endpoints/user_responses.py      27      9    67%
app/api/endpoints/users.py               21      4    81%
app/core/__init__.py                      1      0   100%
app/core/auth.py                         14      6    57%
app/core/config.py                        7      0   100%
app/core/jwt.py                          28      6    79%
app/core/security.py                      7      0   100%
app/crud/__init__.py                      4      0   100%
app/crud/crud_question_sets.py           28      4    86%
app/crud/crud_questions.py               31      8    74%
app/crud/crud_user.py                    28      3    89%
app/crud/crud_user_responses.py          13      1    92%
app/db/__init__.py                        2      0   100%
app/db/base_class.py                      3      0   100%
app/db/session.py                        14      5    64%
app/main.py                              27      2    93%
app/models/__init__.py                    8      0   100%
app/models/answer_choices.py             11      0   100%
app/models/question_sets.py               9      0   100%
app/models/questions.py                  13      0   100%
app/models/subjects.py                    9      0   100%
app/models/subtopics.py                  11      0   100%
app/models/token.py                       8      0   100%
app/models/topics.py                     11      0   100%
app/models/user_responses.py             18      0   100%
app/models/users.py                      11      0   100%
app/schemas/__init__.py                   6      0   100%
app/schemas/auth.py                       4      0   100%
app/schemas/question_sets.py             12      0   100%
app/schemas/questions.py                 15      0   100%
app/schemas/token.py                      5      0   100%
app/schemas/user.py                      24      0   100%
app/schemas/user_responses.py            15      0   100%
---------------------------------------------------------
TOTAL                                   594     81    86%

=========================== short test summary info ============================
FAILED tests/test_api_authentication.py::test_login_and_access_protected_endpoint
FAILED tests/test_api_authentication.py::test_access_protected_endpoint_with_invalid_token
FAILED tests/test_api_authentication.py::test_login_success - assert 422 == 200
FAILED tests/test_api_authentication.py::test_login_invalid_credentials - ass...
FAILED tests/test_api_authentication.py::test_logout_success - AttributeError...
FAILED tests/test_api_authentication.py::test_login_inactive_user - assert 42...
FAILED tests/test_api_authentication.py::test_login_invalid_token_format - At...
FAILED tests/test_api_authentication.py::test_login_expired_token - Attribute...
FAILED tests/test_api_authentication.py::test_login_logout_flow - assert 422 ...
FAILED tests/test_api_users.py::test_read_users - AttributeError: 'Depends' o...
FAILED tests/test_auth_integration.py::test_protected_route_with_valid_token
FAILED tests/test_auth_integration.py::test_protected_route_with_invalid_token
FAILED tests/test_auth_integration.py::test_protected_route_with_revoked_token
======================== 13 failed, 54 passed in 19.84s ========================
